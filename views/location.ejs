<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Completing Check-in</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h2>Completing check-in...</h2>
    <div id="message">Acquiring location â€” please allow the browser to share location.</div>
  </div>

  <script>
    const token = '<%= token %>';

    function postLocation(lat, lng) {
      fetch('/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, latitude: lat, longitude: lng })
      })
      .then(r => r.text())
      .then(t => {
        // Redirect to Singpass login page after check-in
        window.location.href = 'https://www.singpass.gov.sg/home/ui/login';
      })
      .catch(e => document.getElementById('message').innerText = 'Error: ' + e.message);
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        document.getElementById('message').innerText = 'Location acquired. Sending...';
        postLocation(pos.coords.latitude, pos.coords.longitude);
      }, (err) => {
        document.getElementById('message').innerText = 'Location denied or unavailable. Sending without location...';
        postLocation(null, null);
      }, { enableHighAccuracy: true, timeout: 10000 });
    } else {
      document.getElementById('message').innerText = 'Geolocation not supported. Sending without location...';
      postLocation(null, null);
    }
  </script>
</body>
</html>